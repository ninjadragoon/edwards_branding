<div id="employee-news">
    <div class="news-headings clearfix">
            <h4>employee news</h4>
            <a href="#" class="clickable-anchor">view all</a>
        </div>
        <div class="detail-sec">
            <a class="cards-heading">-</a>
            <!-- <span>-</span> -->
            <span class="date">-</span>
        </div>
        <div class="detail-sec">
            <a class="cards-heading">-</a>
            <!-- <span>-</span> -->
            <span class="date">-</span>
        </div>
        <div class="detail-sec">
            <a class="cards-heading">-</a>
            <!-- <span>-</span> -->
            <span class="date">-</span>
        </div>
        <div class="detail-sec">
            <a class="cards-heading">-</a>
            <!-- <span>-</span> -->
            <span class="date">-</span>
        </div>
        <div class="detail-sec">
            <a class="cards-heading">-</a>
            <!-- <span>-</span> -->
            <span class="date">-</span>
        </div>
</div>


<script>
    /*===  variables ===*/
	var empNews = {
		clientContext: null,
		oList: null,
		editMode: false,
		responseMsg: '',
		items: [],
		categories: ['employee news']
	};
    /*===  variables ===*/	
    
    /*===  helper functions ===*/
	empNews.onQueryFailed = function(sender, args) {
		debugger;
		var customMsg = this.errorMsg? this.errorMsg : '';
		alert(customMsg + args.get_message() + '\n' + args.get_stackTrace());
	}
	
	/*===  visible = string('show'/'hide'), itemType = 'image'/'text', item = $(this) ===*/
	empNews.manageVisibility = function(visible, item){
        if(visible == 'show')
            item.css("display", "block");
        else
            item.css("display", "none");				
	}
    /*===  helper functions ===*/
    
    $( document ).ready(function() {
		SP.SOD.executeFunc('sp.js', 'SP.ClientContext', function(){
            empNews.getItems();
		});
	});

    empNews.getItems = function(){
	    empNews.clientContext = new SP.ClientContext();
		empNews.oList = empNews.clientContext.get_web().get_lists().getByTitle('News');
		var camlQuery = new SP.CamlQuery();
        //where IsActive = 1 && (Category = 'employee news') limit 5 order by Order0 asc
		var q = "<View><Query><Where><And>" +"<Eq>" + "<FieldRef Name='IsActive' />" + "<Value Type='Boolean'>1</Value>" + "</Eq>" +  "<Eq><FieldRef Name='Category'/><Value Type='Choice'>" + empNews.categories[0] + "</Value></Eq>"  + " </And></Where>" + "<OrderBy><FieldRef Name='Order0' Ascending='True' /></OrderBy>" + "</Query>" + "<RowLimit>5</RowLimit></View>";
		camlQuery.set_viewXml(q);
		empNews.collListItem = empNews.oList.getItems(camlQuery);
		empNews.clientContext.load(empNews.collListItem);
		this.errorMsg = "Get list items request failed! "; //this is available in success/error functions called below;
		empNews.clientContext.executeQueryAsync(Function.createDelegate(this, empNews.onGetItemsQuerySucceeded), Function.createDelegate(this, empNews.onQueryFailed));        
    }
    
    empNews.onGetItemsQuerySucceeded = function(sender, args) {
		var listItemEnumerator = empNews.collListItem.getEnumerator();	
		while (listItemEnumerator.moveNext()) {
			var oListItem = listItemEnumerator.get_current();
			var item = {
				id: oListItem.get_item('ID'),
				title: oListItem.get_item('Title'),
				url: oListItem.get_item('Url'),
				order: oListItem.get_item('Order0'),
				category: oListItem.get_item('Category'),
				articlePublishDate: oListItem.get_item('ArticlePublishDate')
                };
                
				empNews.items.push(item);
		}	
		
		empNews.renderItems();
    }
    
    empNews.renderItems = function(){
        if(empNews.items.length){
            $('#employee-news .detail-sec').each(function(i, obj) {
                if(empNews.items[i]){
                    $(this).find('.cards-heading').text(empNews.items[i].title).attr('href', empNews.items[i].url.$1_1).attr("target","_blank");
                    if(empNews.items[i].articlePublishDate)
                        $(this).find('span.date').text(empNews.items[i].articlePublishDate.toString().slice(4, 10));
                    
                    empNews.manageVisibility('show', $(this));
                }
                else
                    empNews.manageVisibility('hide', $(this));

                if(!(empNews.items[i+1])){
                        $(this).css('border', 'none');
                    }
            });
        }
    }


</script>
